// ===============================================
// ðŸ” FIRESTORE SECURITY RULES - GESTIHOTEL
// ===============================================
// Version: 2.0.0
// DerniÃ¨re mise Ã  jour: 2025-11-04
// 
// âœ… SÃ©curitÃ© renforcÃ©e par rÃ´le
// âœ… Validation des schÃ©mas
// âœ… Protection contre les escalades de privilÃ¨ges
// âœ… Audit trails

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===============================================
    // ðŸ”§ FONCTIONS HELPER
    // ===============================================
    
    /**
     * VÃ©rifier si l'utilisateur est authentifiÃ©
     */
    function isAuthenticated() {
      return request.auth != null;
    }
    
    /**
     * VÃ©rifier si l'utilisateur est le propriÃ©taire
     */
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    /**
     * RÃ©cupÃ©rer les donnÃ©es utilisateur courantes
     */
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    /**
     * VÃ©rifier si l'utilisateur est actif
     */
    function isActive() {
      return isAuthenticated() 
             && getUserData().active == true;
    }
    
    /**
     * VÃ©rifier le rÃ´le de l'utilisateur
     */
    function hasRole(role) {
      return isActive() 
             && getUserData().role == role;
    }
    
    /**
     * VÃ©rifier si l'utilisateur a un des rÃ´les
     */
    function hasAnyRole(roles) {
      return isActive() 
             && getUserData().role in roles;
    }
    
    /**
     * VÃ©rifier si Super Admin
     */
    function isSuperAdmin() {
      return hasRole('superadmin');
    }
    
    /**
     * VÃ©rifier si Manager ou Super Admin
     */
    function isManagerOrAbove() {
      return hasAnyRole(['manager', 'superadmin']);
    }
    
    /**
     * VÃ©rifier si l'utilisateur peut gÃ©rer les utilisateurs
     */
    function canManageUsers() {
      return isSuperAdmin();
    }
    
    /**
     * VÃ©rifier si l'intervention est assignÃ©e Ã  l'utilisateur
     */
    function isAssignedTo(interventionId) {
      return isActive() 
             && get(/databases/$(database)/documents/interventions/$(interventionId)).data.assignedTo == request.auth.uid;
    }
    
    /**
     * VÃ©rifier si l'utilisateur a crÃ©Ã© l'intervention
     */
    function isCreator(interventionId) {
      return isActive()
             && get(/databases/$(database)/documents/interventions/$(interventionId)).data.createdBy == request.auth.uid;
    }
    
    /**
     * Validation des champs requis
     */
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }
    
    /**
     * VÃ©rifier qu'aucun champ n'a Ã©tÃ© supprimÃ©
     */
    function noFieldsRemoved() {
      return request.resource.data.keys().hasAll(resource.data.keys());
    }
    
    /**
     * VÃ©rifier que certains champs n'ont pas changÃ©
     */
    function fieldsUnchanged(fields) {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(fields);
    }
    
    // ===============================================
    // ðŸ‘¥ COLLECTION: USERS
    // ===============================================
    
    match /users/{userId} {
      
      // âœ… LECTURE: Tous les utilisateurs authentifiÃ©s
      allow read: if isAuthenticated();
      
      // âœ… CRÃ‰ATION: Super Admin uniquement
      allow create: if isSuperAdmin()
                    && hasRequiredFields(['email', 'role', 'name', 'active', 'createdAt', 'createdBy']);
      
      // âœ… MISE Ã€ JOUR: 
      // - PropriÃ©taire peut modifier ses propres infos (sauf rÃ´le)
      // - Super Admin peut tout modifier
      allow update: if (isOwner(userId) && fieldsUnchanged(['role', 'active', 'email']))
                    || isSuperAdmin();
      
      // âœ… SUPPRESSION: Super Admin uniquement
      allow delete: if isSuperAdmin();
      
      // ðŸ”’ Validation du schÃ©ma user
      allow create, update: if request.resource.data.role in ['superadmin', 'manager', 'reception', 'technician']
                            && request.resource.data.active is bool
                            && request.resource.data.email is string
                            && request.resource.data.name is string;
    }
    
    // ===============================================
    // ðŸ”§ COLLECTION: INTERVENTIONS
    // ===============================================
    
    match /interventions/{interventionId} {
      
      // âœ… LECTURE: Tous les utilisateurs actifs
      allow read: if isActive();
      
      // âœ… CRÃ‰ATION: Tous les utilisateurs actifs
      allow create: if isActive()
                    && hasRequiredFields(['missionSummary', 'status', 'createdAt', 'createdBy', 'createdByName'])
                    && request.resource.data.createdBy == request.auth.uid;
      
      // âœ… MISE Ã€ JOUR:
      // - Manager et SuperAdmin: Tout
      // - Technicien assignÃ©: Ses interventions
      // - RÃ©ception/CrÃ©ateur: Tant que pas assignÃ©e
      allow update: if isManagerOrAbove()
                    || (isAssignedTo(interventionId) && hasRole('technician'))
                    || (isCreator(interventionId) && hasRole('reception'));
      
      // âœ… SUPPRESSION: Super Admin uniquement
      allow delete: if isSuperAdmin();
      
      // ðŸ”’ Validation du schÃ©ma intervention
      allow create, update: if request.resource.data.status in ['todo', 'inprogress', 'completed', 'cancelled', 'onhold']
                            && (request.resource.data.priority == null || request.resource.data.priority in ['urgent', 'high', 'normal', 'low'])
                            && request.resource.data.missionSummary is string
                            && request.resource.data.missionSummary.size() > 0
                            && request.resource.data.missionSummary.size() <= 500;
      
      // ðŸ”’ EmpÃªcher modification de certains champs systÃ¨me
      allow update: if fieldsUnchanged(['createdAt', 'createdBy', 'createdByName', 'id']);
    }
    
    // ===============================================
    // ðŸ“‹ COLLECTION: DROPDOWN OPTIONS
    // ===============================================
    
    match /dropdownOptions/{optionId} {
      
      // âœ… LECTURE: Tous les utilisateurs authentifiÃ©s
      allow read: if isAuthenticated();
      
      // âœ… Ã‰CRITURE: Manager et Super Admin
      allow create, update: if isManagerOrAbove()
                            && hasRequiredFields(['category', 'value', 'active', 'createdAt', 'createdBy']);
      
      // âœ… SUPPRESSION: Super Admin uniquement
      allow delete: if isSuperAdmin();
      
      // ðŸ”’ Validation catÃ©gories autorisÃ©es
      allow create, update: if request.resource.data.category in [
        'roomTypes',
        'locations', 
        'missionTypes',
        'interventionTypes',
        'priorities',
        'departments',
        'creators'
      ];
    }
    
    // ===============================================
    // ðŸ¢ COLLECTION: ADMIN DATA
    // ===============================================
    
    match /adminData/{dataId} {
      
      // âœ… LECTURE: Tous les utilisateurs authentifiÃ©s
      allow read: if isAuthenticated();
      
      // âœ… Ã‰CRITURE: Manager et Super Admin
      allow create, update: if isManagerOrAbove()
                            && hasRequiredFields(['type', 'active', 'createdAt', 'createdBy']);
      
      // âœ… SUPPRESSION: Super Admin uniquement
      allow delete: if isSuperAdmin();
      
      // ðŸ”’ Validation types autorisÃ©s
      allow create, update: if request.resource.data.type in [
        'technicians',
        'suppliers',
        'equipment'
      ];
    }
    
    // ===============================================
    // ðŸš« COLLECTION: BLOCKED ROOMS
    // ===============================================
    
    match /blockedRooms/{roomId} {
      
      // âœ… LECTURE: Tous les utilisateurs authentifiÃ©s
      allow read: if isAuthenticated();
      
      // âœ… CRÃ‰ATION: Reception, Manager, Super Admin
      allow create: if hasAnyRole(['reception', 'manager', 'superadmin'])
                    && hasRequiredFields(['roomNumber', 'blocked', 'blockedAt', 'blockedBy', 'blockedByName']);
      
      // âœ… MISE Ã€ JOUR: Reception, Manager, Super Admin
      allow update: if hasAnyRole(['reception', 'manager', 'superadmin']);
      
      // âœ… SUPPRESSION: Manager et Super Admin
      allow delete: if isManagerOrAbove();
      
      // ðŸ”’ Validation schÃ©ma
      allow create, update: if request.resource.data.blocked is bool
                            && request.resource.data.roomNumber is string;
    }
    
    // ===============================================
    // ðŸ’¬ COLLECTION: MESSAGES (sous-collection)
    // ===============================================
    
    match /interventions/{interventionId}/messages/{messageId} {
      
      // âœ… LECTURE: Utilisateurs actifs
      allow read: if isActive();
      
      // âœ… CRÃ‰ATION: Utilisateurs actifs
      allow create: if isActive()
                    && hasRequiredFields(['text', 'senderId', 'senderName', 'timestamp'])
                    && request.resource.data.senderId == request.auth.uid;
      
      // âœ… MISE Ã€ JOUR: PropriÃ©taire du message uniquement
      allow update: if isActive()
                    && resource.data.senderId == request.auth.uid;
      
      // âœ… SUPPRESSION: PropriÃ©taire ou Super Admin
      allow delete: if isSuperAdmin()
                    || (isActive() && resource.data.senderId == request.auth.uid);
      
      // ðŸ”’ Validation message
      allow create, update: if request.resource.data.text is string
                            && request.resource.data.text.size() > 0
                            && request.resource.data.text.size() <= 5000;
    }
    
    // ===============================================
    // ðŸ“Š COLLECTION: ANALYTICS (lecture seule)
    // ===============================================
    
    match /analytics/{docId} {
      
      // âœ… LECTURE: Manager et Super Admin
      allow read: if isManagerOrAbove();
      
      // âœ… Ã‰CRITURE: Uniquement via Cloud Functions
      allow write: if false;
    }
    
    // ===============================================
    // ðŸ“ COLLECTION: AUDIT LOGS
    // ===============================================
    
    match /auditLogs/{logId} {
      
      // âœ… LECTURE: Super Admin uniquement
      allow read: if isSuperAdmin();
      
      // âœ… CRÃ‰ATION: Via Cloud Functions uniquement
      allow create: if false;
      
      // âœ… PAS DE MODIFICATION/SUPPRESSION
      allow update, delete: if false;
    }
    
    // ===============================================
    // âš™ï¸ COLLECTION: SETTINGS
    // ===============================================
    
    match /settings/{userId} {
      
      // âœ… LECTURE: PropriÃ©taire uniquement
      allow read: if isOwner(userId);
      
      // âœ… Ã‰CRITURE: PropriÃ©taire uniquement
      allow create, update: if isOwner(userId);
      
      // âœ… SUPPRESSION: PropriÃ©taire uniquement
      allow delete: if isOwner(userId);
    }
    
    // ===============================================
    // ðŸ”” COLLECTION: NOTIFICATIONS
    // ===============================================
    
    match /notifications/{notificationId} {
      
      // âœ… LECTURE: Destinataire uniquement
      allow read: if isAuthenticated()
                  && resource.data.userId == request.auth.uid;
      
      // âœ… CRÃ‰ATION: Via Cloud Functions
      allow create: if false;
      
      // âœ… MISE Ã€ JOUR: Destinataire (pour marquer comme lu)
      allow update: if isAuthenticated()
                    && resource.data.userId == request.auth.uid
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']);
      
      // âœ… SUPPRESSION: Destinataire
      allow delete: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;
    }
    
    // ===============================================
    // ðŸ—‚ï¸ COLLECTION: TEMPLATES
    // ===============================================
    
    match /templates/{templateId} {
      
      // âœ… LECTURE: Tous les utilisateurs actifs
      allow read: if isActive();
      
      // âœ… Ã‰CRITURE: Manager et Super Admin
      allow create, update: if isManagerOrAbove();
      
      // âœ… SUPPRESSION: Super Admin uniquement
      allow delete: if isSuperAdmin();
    }
    
    // ===============================================
    // ðŸ“± COLLECTION: FCM TOKENS (notifications push)
    // ===============================================
    
    match /fcmTokens/{tokenId} {
      
      // âœ… LECTURE: PropriÃ©taire uniquement
      allow read: if isAuthenticated()
                  && resource.data.userId == request.auth.uid;
      
      // âœ… CRÃ‰ATION: Utilisateur pour son propre token
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid;
      
      // âœ… MISE Ã€ JOUR: PropriÃ©taire
      allow update: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;
      
      // âœ… SUPPRESSION: PropriÃ©taire
      allow delete: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;
    }
    
    // ===============================================
    // ðŸš« RÃˆGLE PAR DÃ‰FAUT
    // ===============================================
    
    // â›” BLOQUER tout le reste par dÃ©faut
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

// ===============================================
// ðŸ“š DOCUMENTATION DES RÃ”LES
// ===============================================
/*
 * HIÃ‰RARCHIE DES RÃ”LES:
 * 
 * 1. superadmin (Super Administrateur)
 *    - AccÃ¨s total Ã  toutes les ressources
 *    - Peut crÃ©er/modifier/supprimer des utilisateurs
 *    - Peut supprimer des interventions
 *    - AccÃ¨s aux audit logs
 * 
 * 2. manager (Gestionnaire)
 *    - Peut gÃ©rer toutes les interventions
 *    - Peut gÃ©rer les options admin (dropdowns, data)
 *    - Peut bloquer/dÃ©bloquer des chambres
 *    - AccÃ¨s aux analytics
 *    - Ne peut PAS gÃ©rer les utilisateurs
 * 
 * 3. reception (RÃ©ception)
 *    - Peut crÃ©er des interventions
 *    - Peut modifier les interventions qu'elle a crÃ©Ã©es (si non assignÃ©es)
 *    - Peut bloquer/dÃ©bloquer des chambres
 *    - Lecture seule pour le reste
 * 
 * 4. technician (Technicien)
 *    - Peut voir toutes les interventions
 *    - Peut modifier les interventions qui lui sont assignÃ©es
 *    - Peut ajouter des messages et photos
 *    - Lecture seule pour le reste
 * 
 * EXEMPLES DE CAS D'USAGE:
 * 
 * - Un technicien NE PEUT PAS modifier une intervention d'un autre technicien
 * - Un rÃ©ceptionniste NE PEUT PAS modifier une intervention dÃ©jÃ  assignÃ©e
 * - Seul un SuperAdmin peut crÃ©er/supprimer des comptes utilisateurs
 * - Les utilisateurs inactifs (active: false) n'ont AUCUN accÃ¨s
 */

// ===============================================
// ðŸ” TESTING DES RÃˆGLES
// ===============================================
/*
 * COMMANDES FIREBASE CLI:
 * 
 * # DÃ©ployer les rÃ¨gles
 * firebase deploy --only firestore:rules
 * 
 * # Tester les rÃ¨gles localement
 * firebase emulators:start --only firestore
 * 
 * # Simulateur de rÃ¨gles (Firebase Console)
 * https://console.firebase.google.com/project/[PROJECT]/firestore/rules
 * 
 * EXEMPLES DE TESTS:
 * 
 * Test 1: Technicien lit une intervention
 * âœ… GET /interventions/ABC123
 *    auth: { uid: 'tech1', token: { role: 'technician', active: true } }
 * 
 * Test 2: RÃ©ception crÃ©e une intervention
 * âœ… CREATE /interventions/ABC124
 *    auth: { uid: 'recep1', token: { role: 'reception', active: true } }
 *    data: { missionSummary: 'Test', status: 'todo', createdBy: 'recep1' }
 * 
 * Test 3: Utilisateur inactif tente de lire
 * âŒ GET /interventions/ABC123
 *    auth: { uid: 'user1', token: { role: 'technician', active: false } }
 * 
 * Test 4: Technicien tente de modifier l'intervention d'un autre
 * âŒ UPDATE /interventions/ABC123
 *    auth: { uid: 'tech1' }
 *    existing.assignedTo: 'tech2'
 */

// ===============================================
// âš ï¸ AVERTISSEMENTS
// ===============================================
/*
 * IMPORTANT:
 * 
 * 1. âœ… Toujours tester les rÃ¨gles avant de dÃ©ployer en production
 * 2. âœ… Utiliser les Cloud Functions pour les opÃ©rations sensibles
 * 3. âœ… Activer App Check pour protection supplÃ©mentaire
 * 4. âœ… Monitorer les erreurs "permission denied" dans Firebase Console
 * 5. âœ… CrÃ©er des index Firestore pour les requÃªtes complexes
 * 6. âš ï¸ Ces rÃ¨gles supposent que tous les users ont un document dans /users/
 * 7. âš ï¸ Les Cloud Functions doivent bypass ces rÃ¨gles (admin SDK)
 * 
 * PERFORMANCE:
 * 
 * - Les `get()` dans les rules comptent dans les quotas de lecture
 * - Limiter les appels `get()` en utilisant le cache cÃ´tÃ© client
 * - Pour de meilleures performances, dupliquer le rÃ´le dans le token JWT
 */

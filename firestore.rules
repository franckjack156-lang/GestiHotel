rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==================== FONCTIONS HELPER ====================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isActive() {
      return isAuthenticated() && getUserData().active == true;
    }
    
    function hasRole(role) {
      return isActive() && getUserData().role == role;
    }
    
    function hasAnyRole(roles) {
      return isActive() && getUserData().role in roles;
    }
    
    function isSuperAdmin() {
      return hasRole('superadmin');
    }
    
    function isManagerOrAbove() {
      return hasAnyRole(['manager', 'superadmin']);
    }
    
    function canManageUsers() {
      return isSuperAdmin();
    }
    
    // NOUVEAU: Accès multi-établissements
    function hasEstablishmentAccess(establishmentId) {
      return isAuthenticated() 
             && (isSuperAdmin() 
                 || (getUserData().keys().hasAll(['establishmentIds']) 
                     && establishmentId in getUserData().establishmentIds));
    }
    
    function isAssignedTo(interventionId) {
      return isActive() 
             && get(/databases/$(database)/documents/interventions/$(interventionId)).data.assignedTo == request.auth.uid;
    }
    
    function isCreator(interventionId) {
      return isActive()
             && get(/databases/$(database)/documents/interventions/$(interventionId)).data.createdBy == request.auth.uid;
    }
    
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }
    
    function noFieldsRemoved() {
      return request.resource.data.keys().hasAll(resource.data.keys());
    }
    
    function fieldsUnchanged(fields) {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(fields);
    }
    
    // ==================== ESTABLISHMENTS ====================
    
    match /establishments/{establishmentId} {
      allow read: if isAuthenticated() && (isSuperAdmin() || hasEstablishmentAccess(establishmentId));
      allow create: if isSuperAdmin() && hasRequiredFields(['name', 'active', 'features', 'createdAt', 'createdBy']);
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
      allow create, update: if request.resource.data.name is string 
                            && request.resource.data.active is bool 
                            && request.resource.data.features is map;
    }
    
    // ==================== USERS ====================
    
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isSuperAdmin() 
                    && hasRequiredFields(['email', 'role', 'name', 'active', 'establishmentIds', 'createdAt', 'createdBy']);
      allow update: if (isOwner(userId) && fieldsUnchanged(['role', 'active', 'email', 'establishmentIds'])) 
                    || isSuperAdmin();
      allow delete: if isSuperAdmin();
      allow create, update: if request.resource.data.role in ['superadmin', 'manager', 'reception', 'technician']
                            && request.resource.data.active is bool
                            && request.resource.data.email is string
                            && request.resource.data.name is string
                            && request.resource.data.establishmentIds is list;
    }
    
    // ==================== INTERVENTIONS ====================
    
    match /interventions/{interventionId} {
      allow read: if isActive() && hasEstablishmentAccess(resource.data.establishmentId);
      allow create: if isActive()
                    && hasRequiredFields(['missionSummary', 'status', 'establishmentId', 'createdAt', 'createdBy', 'createdByName'])
                    && request.resource.data.createdBy == request.auth.uid
                    && hasEstablishmentAccess(request.resource.data.establishmentId);
      allow update: if hasEstablishmentAccess(resource.data.establishmentId)
                    && (isManagerOrAbove() 
                        || (isAssignedTo(interventionId) && hasRole('technician'))
                        || (isCreator(interventionId) && hasRole('reception')));
      allow delete: if isSuperAdmin() && hasEstablishmentAccess(resource.data.establishmentId);
      allow create, update: if request.resource.data.status in ['todo', 'inprogress', 'completed', 'cancelled', 'onhold']
                            && (request.resource.data.priority == null || request.resource.data.priority in ['urgent', 'high', 'normal', 'low'])
                            && request.resource.data.missionSummary is string
                            && request.resource.data.missionSummary.size() > 0
                            && request.resource.data.missionSummary.size() <= 500
                            && request.resource.data.establishmentId is string;
      allow update: if fieldsUnchanged(['createdAt', 'createdBy', 'createdByName', 'id', 'establishmentId']);
    }
    
    // ==================== DROPDOWN OPTIONS ====================
    
    match /dropdownOptions/{optionId} {
      allow read: if isAuthenticated() && hasEstablishmentAccess(resource.data.establishmentId);
      allow create: if isManagerOrAbove()
                    && hasRequiredFields(['category', 'value', 'active', 'establishmentId', 'createdAt', 'createdBy'])
                    && hasEstablishmentAccess(request.resource.data.establishmentId);
      allow update: if isManagerOrAbove() 
                    && hasEstablishmentAccess(resource.data.establishmentId) 
                    && fieldsUnchanged(['establishmentId']);
      allow delete: if isSuperAdmin() && hasEstablishmentAccess(resource.data.establishmentId);
      allow create, update: if request.resource.data.category in [
                              'roomTypes', 'locations', 'missionTypes', 'interventionTypes', 
                              'priorities', 'departments', 'creators'
                            ] && request.resource.data.establishmentId is string;
    }
    
    // ==================== ADMIN DATA ====================
    
    match /adminData/{dataId} {
      allow read: if isAuthenticated() && hasEstablishmentAccess(resource.data.establishmentId);
      allow create: if isManagerOrAbove()
                    && hasRequiredFields(['type', 'active', 'establishmentId', 'createdAt', 'createdBy'])
                    && hasEstablishmentAccess(request.resource.data.establishmentId);
      allow update: if isManagerOrAbove() 
                    && hasEstablishmentAccess(resource.data.establishmentId) 
                    && fieldsUnchanged(['establishmentId']);
      allow delete: if isSuperAdmin() && hasEstablishmentAccess(resource.data.establishmentId);
      allow create, update: if request.resource.data.type in ['technicians', 'suppliers', 'equipment']
                            && request.resource.data.establishmentId is string;
    }
    
    // ==================== BLOCKED ROOMS ====================
    
    match /blockedRooms/{roomId} {
      allow read: if isAuthenticated() && hasEstablishmentAccess(resource.data.establishmentId);
      allow create: if hasAnyRole(['reception', 'manager', 'superadmin'])
                    && hasRequiredFields(['roomNumber', 'blocked', 'establishmentId', 'blockedAt', 'blockedBy', 'blockedByName'])
                    && hasEstablishmentAccess(request.resource.data.establishmentId);
      allow update: if hasAnyRole(['reception', 'manager', 'superadmin']) 
                    && hasEstablishmentAccess(resource.data.establishmentId) 
                    && fieldsUnchanged(['establishmentId']);
      allow delete: if isManagerOrAbove() && hasEstablishmentAccess(resource.data.establishmentId);
      allow create, update: if request.resource.data.blocked is bool
                            && request.resource.data.roomNumber is string
                            && request.resource.data.establishmentId is string;
    }
    
    // ==================== MESSAGES ====================
    
    match /interventions/{interventionId}/messages/{messageId} {
      allow read: if isActive() 
                  && hasEstablishmentAccess(get(/databases/$(database)/documents/interventions/$(interventionId)).data.establishmentId);
      allow create: if isActive()
                    && hasRequiredFields(['text', 'senderId', 'senderName', 'timestamp'])
                    && request.resource.data.senderId == request.auth.uid
                    && hasEstablishmentAccess(get(/databases/$(database)/documents/interventions/$(interventionId)).data.establishmentId);
      allow update: if isActive()
                    && resource.data.senderId == request.auth.uid
                    && hasEstablishmentAccess(get(/databases/$(database)/documents/interventions/$(interventionId)).data.establishmentId);
      allow delete: if hasEstablishmentAccess(get(/databases/$(database)/documents/interventions/$(interventionId)).data.establishmentId)
                    && (isSuperAdmin() || (isActive() && resource.data.senderId == request.auth.uid));
      allow create, update: if request.resource.data.text is string
                            && request.resource.data.text.size() > 0
                            && request.resource.data.text.size() <= 5000;
    }
    
    // ==================== ANALYTICS ====================
    
    match /analytics/{docId} {
      allow read: if isManagerOrAbove();
      allow write: if false;
    }
    
    // ==================== AUDIT LOGS ====================
    
    match /auditLogs/{logId} {
      allow read: if isSuperAdmin();
      allow create: if false;
      allow update, delete: if false;
    }
    
    // ==================== USER SETTINGS ====================
    
    match /userSettings/{userId} {
      allow read: if isOwner(userId);
      allow create, update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }
    
    // ==================== NOTIFICATIONS ====================
    
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if false;
      allow update: if isAuthenticated() 
                    && resource.data.userId == request.auth.uid 
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']);
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // ==================== TEMPLATES ====================
    
    match /templates/{templateId} {
      allow read: if isActive();
      allow create, update: if isManagerOrAbove();
      allow delete: if isSuperAdmin();
    }
    
    // ==================== FCM TOKENS ====================
    
    match /fcmTokens/{tokenId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // ==================== RÈGLE PAR DÉFAUT ====================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

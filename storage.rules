// ===============================================
// üîê FIREBASE STORAGE SECURITY RULES - GESTIHOTEL
// ===============================================
// Version: 2.0.0
// Derni√®re mise √† jour: 2025-11-04
// 
// ‚úÖ Validation stricte des types de fichiers
// ‚úÖ Limitation des tailles
// ‚úÖ Permissions par r√¥le
// ‚úÖ Protection contre uploads malveillants

rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // ===============================================
    // üîß FONCTIONS HELPER
    // ===============================================
    
    /**
     * V√©rifier si l'utilisateur est authentifi√©
     */
    function isAuthenticated() {
      return request.auth != null;
    }
    
    /**
     * V√©rifier si l'utilisateur est le propri√©taire
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    /**
     * V√©rifier la taille du fichier (en bytes)
     */
    function isSizeValid(maxSize) {
      return request.resource.size <= maxSize;
    }
    
    /**
     * V√©rifier le type MIME du fichier
     */
    function isImageFile() {
      return request.resource.contentType.matches('image/(jpeg|jpg|png|webp|gif)');
    }
    
    /**
     * V√©rifier si c'est un fichier PDF
     */
    function isPDFFile() {
      return request.resource.contentType == 'application/pdf';
    }
    
    /**
     * V√©rifier si c'est un fichier Excel
     */
    function isExcelFile() {
      return request.resource.contentType.matches('application/(vnd.ms-excel|vnd.openxmlformats-officedocument.spreadsheetml.sheet)');
    }
    
    /**
     * V√©rifier si c'est un fichier Word
     */
    function isWordFile() {
      return request.resource.contentType.matches('application/(msword|vnd.openxmlformats-officedocument.wordprocessingml.document)');
    }
    
    /**
     * Limites de taille pr√©d√©finies
     */
    function maxImageSize() {
      return 5 * 1024 * 1024; // 5 MB
    }
    
    function maxAvatarSize() {
      return 2 * 1024 * 1024; // 2 MB
    }
    
    function maxDocumentSize() {
      return 10 * 1024 * 1024; // 10 MB
    }
    
    // ===============================================
    // üì∏ PHOTOS D'INTERVENTIONS
    // ===============================================
    
    match /interventions/{interventionId}/{fileName} {
      
      // ‚úÖ LECTURE: Tous les utilisateurs authentifi√©s
      allow read: if isAuthenticated();
      
      // ‚úÖ √âCRITURE: Utilisateurs authentifi√©s avec validations
      allow write: if isAuthenticated()
                   && isImageFile()
                   && isSizeValid(maxImageSize());
      
      // ‚úÖ SUPPRESSION: Utilisateurs authentifi√©s
      allow delete: if isAuthenticated();
    }
    
    // ===============================================
    // üë§ AVATARS UTILISATEURS
    // ===============================================
    
    match /users/{userId}/avatar/{fileName} {
      
      // ‚úÖ LECTURE: Public (pour affichage dans l'app)
      allow read: if true;
      
      // ‚úÖ √âCRITURE: Propri√©taire uniquement
      allow write: if isOwner(userId)
                   && isImageFile()
                   && isSizeValid(maxAvatarSize());
      
      // ‚úÖ SUPPRESSION: Propri√©taire uniquement
      allow delete: if isOwner(userId);
    }
    
    // ===============================================
    // üìÑ DOCUMENTS / RAPPORTS
    // ===============================================
    
    match /documents/{docType}/{fileName} {
      
      // ‚úÖ LECTURE: Utilisateurs authentifi√©s
      allow read: if isAuthenticated();
      
      // ‚úÖ √âCRITURE: Utilisateurs authentifi√©s
      // Types autoris√©s: PDF, Excel, Word
      allow write: if isAuthenticated()
                   && (isPDFFile() || isExcelFile() || isWordFile())
                   && isSizeValid(maxDocumentSize());
      
      // ‚úÖ SUPPRESSION: Utilisateurs authentifi√©s
      allow delete: if isAuthenticated();
    }
    
    // ===============================================
    // üìä EXPORTS (temporaires)
    // ===============================================
    
    match /exports/{userId}/{fileName} {
      
      // ‚úÖ LECTURE: Propri√©taire uniquement
      allow read: if isOwner(userId);
      
      // ‚úÖ √âCRITURE: Propri√©taire uniquement
      // Types: Excel, CSV, PDF
      allow write: if isOwner(userId)
                   && (isExcelFile() 
                       || isPDFFile() 
                       || request.resource.contentType == 'text/csv')
                   && isSizeValid(maxDocumentSize());
      
      // ‚úÖ SUPPRESSION: Propri√©taire uniquement
      allow delete: if isOwner(userId);
    }
    
    // ===============================================
    // üñºÔ∏è IMAGES PUBLIQUES (logos, assets)
    // ===============================================
    
    match /public/{fileName} {
      
      // ‚úÖ LECTURE: Public
      allow read: if true;
      
      // ‚úÖ √âCRITURE: Authentifi√©s uniquement
      allow write: if isAuthenticated()
                   && isImageFile()
                   && isSizeValid(maxImageSize());
      
      // ‚úÖ SUPPRESSION: Authentifi√©s uniquement
      allow delete: if isAuthenticated();
    }
    
    // ===============================================
    // üìù SIGNATURES / FORMULAIRES
    // ===============================================
    
    match /signatures/{interventionId}/{fileName} {
      
      // ‚úÖ LECTURE: Utilisateurs authentifi√©s
      allow read: if isAuthenticated();
      
      // ‚úÖ √âCRITURE: Utilisateurs authentifi√©s
      // Signatures = images PNG
      allow write: if isAuthenticated()
                   && request.resource.contentType == 'image/png'
                   && isSizeValid(1 * 1024 * 1024); // 1 MB max
      
      // ‚úÖ SUPPRESSION: Utilisateurs authentifi√©s
      allow delete: if isAuthenticated();
    }
    
    // ===============================================
    // üîÑ IMPORTS (fichiers Excel pour import de donn√©es)
    // ===============================================
    
    match /imports/{userId}/{fileName} {
      
      // ‚úÖ LECTURE: Propri√©taire uniquement
      allow read: if isOwner(userId);
      
      // ‚úÖ √âCRITURE: Propri√©taire uniquement
      allow write: if isOwner(userId)
                   && isExcelFile()
                   && isSizeValid(maxDocumentSize());
      
      // ‚úÖ SUPPRESSION: Propri√©taire uniquement
      allow delete: if isOwner(userId);
    }
    
    // ===============================================
    // üíæ BACKUPS (syst√®me)
    // ===============================================
    
    match /backups/{backupId}/{fileName} {
      
      // ‚úÖ LECTURE: Authentifi√©s uniquement
      allow read: if isAuthenticated();
      
      // ‚úÖ √âCRITURE: Via Cloud Functions uniquement
      allow write: if false;
      
      // ‚úÖ SUPPRESSION: Interdit (conservation)
      allow delete: if false;
    }
    
    // ===============================================
    // üé® TEMPLATES / MOD√àLES
    // ===============================================
    
    match /templates/{templateType}/{fileName} {
      
      // ‚úÖ LECTURE: Tous les utilisateurs authentifi√©s
      allow read: if isAuthenticated();
      
      // ‚úÖ √âCRITURE: Authentifi√©s uniquement
      allow write: if isAuthenticated()
                   && (isPDFFile() || isExcelFile() || isWordFile())
                   && isSizeValid(maxDocumentSize());
      
      // ‚úÖ SUPPRESSION: Authentifi√©s uniquement
      allow delete: if isAuthenticated();
    }
    
    // ===============================================
    // üìπ VID√âOS (si support vid√©o futur)
    // ===============================================
    
    match /videos/{interventionId}/{fileName} {
      
      // ‚úÖ LECTURE: Utilisateurs authentifi√©s
      allow read: if isAuthenticated();
      
      // ‚úÖ √âCRITURE: Utilisateurs authentifi√©s
      // Limit√© √† 50 MB pour les vid√©os
      allow write: if isAuthenticated()
                   && request.resource.contentType.matches('video/(mp4|webm|quicktime)')
                   && isSizeValid(50 * 1024 * 1024);
      
      // ‚úÖ SUPPRESSION: Utilisateurs authentifi√©s
      allow delete: if isAuthenticated();
    }
    
    // ===============================================
    // üóÇÔ∏è FICHIERS TEMPORAIRES
    // ===============================================
    
    match /temp/{userId}/{fileName} {
      
      // ‚úÖ LECTURE: Propri√©taire uniquement
      allow read: if isOwner(userId);
      
      // ‚úÖ √âCRITURE: Propri√©taire uniquement
      // Tous types, mais limit√© en taille
      allow write: if isOwner(userId)
                   && isSizeValid(maxDocumentSize());
      
      // ‚úÖ SUPPRESSION: Propri√©taire uniquement
      allow delete: if isOwner(userId);
    }
    
    // ===============================================
    // üö´ R√àGLE PAR D√âFAUT
    // ===============================================
    
    // ‚õî BLOQUER tout le reste par d√©faut
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}

// ===============================================
// üìö DOCUMENTATION
// ===============================================
/*
 * STRUCTURE DES DOSSIERS STORAGE:
 * 
 * /interventions/{id}/         - Photos d'interventions (5MB max, images uniquement)
 * /users/{userId}/avatar/      - Avatars utilisateurs (2MB max, images)
 * /documents/{type}/           - Documents divers (10MB max, PDF/Excel/Word)
 * /exports/{userId}/           - Exports temporaires (10MB max, Excel/PDF/CSV)
 * /public/                     - Assets publics (images)
 * /signatures/{id}/            - Signatures √©lectroniques (1MB max, PNG)
 * /imports/{userId}/           - Imports Excel (10MB max)
 * /backups/{id}/               - Backups syst√®me (lecture seule)
 * /templates/{type}/           - Templates documents (10MB max)
 * /videos/{id}/                - Vid√©os (50MB max, mp4/webm)
 * /temp/{userId}/              - Fichiers temporaires (10MB max)
 * 
 * TYPES MIME AUTORIS√âS:
 * 
 * Images:
 * - image/jpeg, image/jpg
 * - image/png
 * - image/webp
 * - image/gif
 * 
 * Documents:
 * - application/pdf
 * - application/vnd.ms-excel
 * - application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
 * - application/msword
 * - application/vnd.openxmlformats-officedocument.wordprocessingml.document
 * - text/csv
 * 
 * Vid√©os:
 * - video/mp4
 * - video/webm
 * - video/quicktime
 * 
 * LIMITES DE TAILLE:
 * 
 * - Avatars: 2 MB
 * - Photos interventions: 5 MB
 * - Documents: 10 MB
 * - Vid√©os: 50 MB
 * - Signatures: 1 MB
 */

// ===============================================
// üîç EXEMPLES D'UTILISATION
// ===============================================
/*
 * UPLOAD PHOTO INTERVENTION:
 * 
 * const file = event.target.files[0];
 * const storageRef = ref(storage, `interventions/${interventionId}/${Date.now()}_${file.name}`);
 * await uploadBytes(storageRef, file);
 * const url = await getDownloadURL(storageRef);
 * 
 * UPLOAD AVATAR:
 * 
 * const storageRef = ref(storage, `users/${userId}/avatar/profile.png`);
 * await uploadBytes(storageRef, file);
 * 
 * UPLOAD EXPORT:
 * 
 * const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
 * const storageRef = ref(storage, `exports/${userId}/rapport_${Date.now()}.xlsx`);
 * await uploadBytes(storageRef, blob);
 * 
 * SUPPRESSION:
 * 
 * const storageRef = ref(storage, filePath);
 * await deleteObject(storageRef);
 */

// ===============================================
// ‚ö†Ô∏è BONNES PRATIQUES
// ===============================================
/*
 * S√âCURIT√â:
 * 
 * 1. ‚úÖ Toujours valider les fichiers c√¥t√© client AVANT upload
 * 2. ‚úÖ Utiliser des noms de fichiers uniques (timestamp + uuid)
 * 3. ‚úÖ Compresser les images avant upload (c√¥t√© client)
 * 4. ‚úÖ Scanner les fichiers avec Cloud Functions apr√®s upload
 * 5. ‚úÖ Nettoyer les fichiers temporaires r√©guli√®rement
 * 6. ‚ö†Ô∏è Ne jamais stocker de donn√©es sensibles dans les m√©tadonn√©es
 * 
 * PERFORMANCE:
 * 
 * 1. ‚úÖ Utiliser des thumbnails pour les images
 * 2. ‚úÖ Impl√©menter le lazy loading
 * 3. ‚úÖ Utiliser Firebase Storage avec CDN
 * 4. ‚úÖ Mettre en cache les URLs (valides 7 jours)
 * 
 * CO√õTS:
 * 
 * 1. ‚úÖ Limiter les tailles de fichiers
 * 2. ‚úÖ Impl√©menter lifecycle rules (suppression auto apr√®s X jours)
 * 3. ‚úÖ Compresser les fichiers
 * 4. ‚úÖ Nettoyer les fichiers orphelins
 * 
 * EXEMPLE CLOUD FUNCTION NETTOYAGE:
 * 
 * exports.cleanupOldExports = functions.pubsub
 *   .schedule('every 24 hours')
 *   .onRun(async () => {
 *     const bucket = admin.storage().bucket();
 *     const [files] = await bucket.getFiles({ prefix: 'exports/' });
 *     
 *     const now = Date.now();
 *     const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 jours
 *     
 *     for (const file of files) {
 *       const [metadata] = await file.getMetadata();
 *       const created = new Date(metadata.timeCreated).getTime();
 *       
 *       if (now - created > maxAge) {
 *         await file.delete();
 *         console.log(`Deleted old file: ${file.name}`);
 *       }
 *     }
 *   });
 */

// ===============================================
// üß™ TESTING
// ===============================================
/*
 * TESTER LES R√àGLES:
 * 
 * 1. Firebase Console > Storage > Rules
 * 2. Utiliser le simulateur de r√®gles
 * 3. Tester diff√©rents sc√©narios
 * 
 * D√âPLOIEMENT:
 * 
 * firebase deploy --only storage:rules
 * 
 * MONITORING:
 * 
 * 1. Firebase Console > Storage > Usage
 * 2. V√©rifier les erreurs "permission denied"
 * 3. Monitorer la taille du bucket
 * 4. Surveiller les co√ªts
 */
